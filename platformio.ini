; PlatformIO Project Configuration File
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = master

[env]
platform = espressif32
framework = arduino
monitor_speed = 115200
extra_scripts = pre:get_version.py

; ===========================================
; MASTER - CAN Reader + SPI Master to Slave
; ===========================================
[env:master]
board = esp32-s3-devkitc-1
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    ; USB serial for device identification (only works with ARDUINO_USB_MODE=0)
    ; With MODE=1 (USB-JTAG), serial is fixed to chip MAC
build_src_filter =
    +<master/>
    -<master/gpio_test.cpp>
lib_deps =
    autowp/autowp-mcp2515@^1.0.0

; ===========================================
; SLAVE - SPI Slave + TFT Display (LVGL UI)
; ===========================================
; Development build - easy flashing, no USB MSC
; Note: ARDUINO_USB_MODE=1 uses hardware USB-JTAG, serial number is fixed to chip MAC
[env:slave]
board = esp32-s3-devkitc-1
extra_scripts = 
    pre:get_version.py
    pre:exclude_arm_asm.py
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DPRODUCTION_BUILD=0
    ; UI selection: LVGL (default) vs legacy TFT_eSPI direct drawing
    -DUSE_LVGL_UI=1
    ; TFT_eSPI configuration for ILI9341/ILI9341V 320x240 display
    -DUSER_SETUP_LOADED=1
    -DILI9341_DRIVER=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    ; ESP32-S3 uses FSPI (SPI2)
    -DUSE_FSPI_PORT=1
    ; SPI pins for ESP32-S3
    -DTFT_MISO=13
    -DTFT_MOSI=11
    -DTFT_SCLK=12
    -DTFT_CS=10
    -DTFT_DC=46
    -DTFT_RST=-1
    -DTFT_BL=45
    ; No SPI touch (using I2C FT6336G instead)
    -DTOUCH_CS=-1
    ; ILI9341V specific - uncomment if colors are inverted
    ; -DTFT_INVERSION_ON
    ; Fonts
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    ; SPI speed - start lower for stability, increase if working
    -DSPI_FREQUENCY=27000000
    -DSPI_READ_FREQUENCY=16000000
    ; LVGL configuration - lv_conf.h is in include/
    -DLV_CONF_INCLUDE_SIMPLE=1
    ; Disable ARM assembly optimizations (not for Xtensa ESP32)
    -DLV_USE_DRAW_SW_ASM=0
build_src_filter =
    +<slave/>
    -<slave/gpio_test.cpp>
    ; Exclude legacy TFT direct-drawing screens when using LVGL
    -<slave/display/legacy/>
lib_deps =
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.0
    lvgl/lvgl@^9.2.0
    ; FT6336G touch uses direct I2C - no library needed
    ; SD card uses built-in SD_MMC library (SDIO interface)

; ===========================================
; SLAVE PRODUCTION - USB MSC enabled, requires BOOT button to flash (LVGL UI)
; ===========================================
; Use: pio run -e slave_prod -t upload
; Flash procedure: Hold BOOT, plug USB, release BOOT, then upload
[env:slave_prod]
board = esp32-s3-devkitc-1
extra_scripts = 
    pre:get_version.py
    pre:exclude_arm_asm.py
build_unflags =
    -DARDUINO_USB_MODE=1
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=0
    -DPRODUCTION_BUILD=1
    ; UI selection: LVGL (default)
    -DUSE_LVGL_UI=1
    ; Custom USB serial for device identification
    '-DUSB_SERIAL="VWCC1-SLAVE"'
    ; TFT_eSPI configuration (same as dev)
    -DUSER_SETUP_LOADED=1
    -DILI9341_DRIVER=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    -DUSE_FSPI_PORT=1
    -DTFT_MISO=13
    -DTFT_MOSI=11
    -DTFT_SCLK=12
    -DTFT_CS=10
    -DTFT_DC=46
    -DTFT_RST=-1
    -DTFT_BL=45
    -DTOUCH_CS=-1
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DSPI_FREQUENCY=27000000
    -DSPI_READ_FREQUENCY=16000000
    ; LVGL configuration - lv_conf.h is in include/
    -DLV_CONF_INCLUDE_SIMPLE=1
    ; Disable ARM assembly optimizations (not for Xtensa ESP32)
    -DLV_USE_DRAW_SW_ASM=0
build_src_filter =
    +<slave/>
    -<slave/gpio_test.cpp>
    ; Exclude legacy TFT direct-drawing screens when using LVGL
    -<slave/display/legacy/>
lib_deps =
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.0
    lvgl/lvgl@^9.2.0

; ===========================================
; SLAVE LEGACY - TFT_eSPI direct drawing (no LVGL)
; ===========================================
; Use: pio run -e slave_legacy
; Smaller flash footprint, uses direct TFT_eSPI drawing
[env:slave_legacy]
board = esp32-s3-devkitc-1
extra_scripts = 
    pre:get_version.py
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=1
    -DPRODUCTION_BUILD=0
    ; UI selection: Legacy TFT_eSPI direct drawing
    -DUSE_LVGL_UI=0
    ; TFT_eSPI configuration for ILI9341/ILI9341V 320x240 display
    -DUSER_SETUP_LOADED=1
    -DILI9341_DRIVER=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    -DUSE_FSPI_PORT=1
    -DTFT_MISO=13
    -DTFT_MOSI=11
    -DTFT_SCLK=12
    -DTFT_CS=10
    -DTFT_DC=46
    -DTFT_RST=-1
    -DTFT_BL=45
    -DTOUCH_CS=-1
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DSPI_FREQUENCY=27000000
    -DSPI_READ_FREQUENCY=16000000
build_src_filter =
    +<slave/>
    -<slave/gpio_test.cpp>
    ; Exclude LVGL screens when using legacy UI
    -<slave/display/lvgl/>
lib_deps =
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.0
    ; No LVGL library for legacy builds

; ===========================================
; SLAVE LEGACY PRODUCTION - USB MSC enabled, TFT_eSPI direct drawing
; ===========================================
; Use: pio run -e slave_legacy_prod -t upload
; Flash procedure: Hold BOOT, plug USB, release BOOT, then upload
[env:slave_legacy_prod]
board = esp32-s3-devkitc-1
extra_scripts = 
    pre:get_version.py
build_unflags =
    -DARDUINO_USB_MODE=1
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=0
    -DPRODUCTION_BUILD=1
    ; UI selection: Legacy TFT_eSPI direct drawing
    -DUSE_LVGL_UI=0
    ; Custom USB serial for device identification
    '-DUSB_SERIAL="VWCC1-SLAVE"'
    ; TFT_eSPI configuration (same as dev)
    -DUSER_SETUP_LOADED=1
    -DILI9341_DRIVER=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=320
    -DUSE_FSPI_PORT=1
    -DTFT_MISO=13
    -DTFT_MOSI=11
    -DTFT_SCLK=12
    -DTFT_CS=10
    -DTFT_DC=46
    -DTFT_RST=-1
    -DTFT_BL=45
    -DTOUCH_CS=-1
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    -DSPI_FREQUENCY=27000000
    -DSPI_READ_FREQUENCY=16000000
build_src_filter =
    +<slave/>
    -<slave/gpio_test.cpp>
    ; Exclude LVGL screens when using legacy UI
    -<slave/display/lvgl/>
lib_deps =
    bodmer/TFT_eSPI@^2.5.0
    bblanchon/ArduinoJson@^6.21.0
    ; No LVGL library for legacy builds

; ===========================================
; MASTER PRODUCTION - Custom USB serial for identification
; ===========================================
; Use: pio run -e master_prod -t upload
; Flash procedure: Hold BOOT, plug USB, release BOOT, then upload
[env:master_prod]
board = esp32-s3-devkitc-1
build_unflags =
    -DARDUINO_USB_MODE=1
build_flags =
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DARDUINO_USB_MODE=0
    ; Custom USB serial for device identification
    '-DUSB_SERIAL="VWCC1-MASTER"'
build_src_filter =
    +<master/>
    -<master/gpio_test.cpp>
lib_deps =
    autowp/autowp-mcp2515@^1.0.0

; ===========================================
; Original generic ESP32 environment (kept for reference)
; ===========================================
[env:esp32dev]
board = esp32dev
build_src_filter =
    +<main.cpp>
